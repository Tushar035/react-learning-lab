# üìò Blog 11: Advanced Middleware Design + Custom Middleware Deep Dive

*(With Diagrams, Real Project Code, Mistakes & Edge Cases)*

> üéØ Goal: Understand Redux middleware like an architect
> üéØ After this blog, you‚Äôll be able to design logging, analytics, error tracking, token refresh, and advanced pipelines.

Middleware is where Redux becomes **enterprise powerful**.

---

# üß† 1Ô∏è‚É£ What Is Middleware (Revisited, Deep Level)

Middleware sits between:

```
dispatch(action)  ‚Üí  reducer
```

But in reality:

```
dispatch
   ‚Üì
middleware 1
   ‚Üì
middleware 2
   ‚Üì
middleware 3
   ‚Üì
reducer
```

Middleware can:

* Log actions
* Modify actions
* Stop actions
* Trigger new actions
* Handle async logic
* Catch errors
* Perform side effects

Think:

üëâ ASP.NET Core request pipeline.

---

# üîÑ 2Ô∏è‚É£ Middleware Pipeline Diagram

![Image](https://redux.js.org/assets/images/ReduxAsyncDataFlowDiagram-d97ff38a0f4da0f327163170ccc13e80.gif)

![Image](https://res.cloudinary.com/infinijith/image/upload/v1673004771/Infinijith%20Blog%20Images/Redux/Redux%20Middleware/Redux_Middleware_Flow_-_Infinijith_kfyb8q.png)

![Image](https://miro.medium.com/1%2A5r9L0GpkiLQ6cd0NGtbtNw.png)

![Image](https://designingforscale.com/content/images/2020/11/reduxMiddleware.png)

Flow:

Component
‚¨á
dispatch(action)
‚¨á
Middleware A
‚¨á
Middleware B
‚¨á
Middleware C
‚¨á
Reducer
‚¨á
New State

Each middleware decides:

* Continue?
* Modify?
* Block?

---

# üèó 3Ô∏è‚É£ Middleware Anatomy (Very Important)

Every middleware looks like this:

```js
const myMiddleware = store => next => action => {
  // before reducer
  const result = next(action);
  // after reducer
  return result;
};
```

Three layers:

1Ô∏è‚É£ store ‚Üí gives getState & dispatch
2Ô∏è‚É£ next ‚Üí passes action to next middleware
3Ô∏è‚É£ action ‚Üí current dispatched action

Understanding this structure = senior-level knowledge.

---

# üè¢ 4Ô∏è‚É£ Real Project Example ‚Äì Enterprise E-Commerce

We‚Äôll implement:

* Logger middleware
* Error tracking middleware
* Auth token refresh middleware
* Analytics middleware

---

# üìù 5Ô∏è‚É£ Logger Middleware (Production Style)

```js
const loggerMiddleware = store => next => action => {
  console.log("Dispatching:", action.type);
  console.log("Previous State:", store.getState());

  const result = next(action);

  console.log("Next State:", store.getState());

  return result;
};
```

Add to store:

```js
export const store = configureStore({
  reducer,
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(loggerMiddleware)
});
```

Used only in development.

---

# üö® 6Ô∏è‚É£ Global Error Handling Middleware

Catch rejected async actions globally.

```js
const errorMiddleware = store => next => action => {
  if (action.type.endsWith("/rejected")) {
    console.error("Global Error:", action.payload || action.error);
  }

  return next(action);
};
```

Benefits:

* Centralized error logging
* Connect to Sentry
* Show global toast

Enterprise pattern.

---

# üîê 7Ô∏è‚É£ Auth Token Refresh Middleware (Real Use Case)

Problem:

API returns 401.
We must refresh token automatically.

```js
const authMiddleware = store => next => action => {
  if (action.type.endsWith("/rejected") && action.payload === "Unauthorized") {
    store.dispatch(refreshToken());
  }

  return next(action);
};
```

This allows:

* Transparent token refresh
* No duplicate logic in components

Very powerful pattern.

---

# üìä 8Ô∏è‚É£ Analytics Middleware

Track user behavior.

```js
const analyticsMiddleware = store => next => action => {
  if (action.type.startsWith("cart/")) {
    console.log("Tracking cart action:", action.type);
  }

  return next(action);
};
```

Send to:

* Google Analytics
* Mixpanel
* Custom tracking system

---

# ‚ö†Ô∏è 9Ô∏è‚É£ Common Middleware Mistakes

---

## ‚ùå Mistake 1: Forgetting to Call `next(action)`

Wrong:

```js
const badMiddleware = store => next => action => {
  console.log(action);
};
```

Action never reaches reducer.

App breaks silently.

Always return:

```js
return next(action);
```

---

## ‚ùå Mistake 2: Dispatching Infinite Loop

Bad:

```js
const loopMiddleware = store => next => action => {
  store.dispatch({ type: "something" });
  return next(action);
};
```

Dispatch ‚Üí middleware ‚Üí dispatch ‚Üí middleware ‚Üí infinite loop.

Always guard condition carefully.

---

## ‚ùå Mistake 3: Mutating Action Object

Bad:

```js
action.type = "modified";
```

Actions should remain immutable.

If needed, create new action.

---

# üß® 1Ô∏è‚É£0Ô∏è‚É£ Edge Cases

---

## üî• Edge Case 1: Middleware Order Matters

```js
middleware: (getDefaultMiddleware) =>
  getDefaultMiddleware()
    .concat(authMiddleware)
    .concat(loggerMiddleware)
```

Order defines execution flow.

If logger is first:

* Logs before auth handling.

Design carefully.

---

## üî• Edge Case 2: Async Inside Middleware

Middleware can handle async.

But be careful:

```js
const asyncMiddleware = store => next => async action => {
  await something();
  return next(action);
};
```

May delay action propagation.

Understand side effects.

---

## üî• Edge Case 3: Accessing Updated State

If you need updated state:

```js
const result = next(action);
const newState = store.getState();
```

Call next first.

Otherwise you get old state.

---

# üèó 1Ô∏è‚É£1Ô∏è‚É£ Combining Multiple Middleware

Enterprise setup:

```js
export const store = configureStore({
  reducer,
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: true,
      immutableCheck: true
    }).concat(
      loggerMiddleware,
      errorMiddleware,
      authMiddleware,
      analyticsMiddleware
    )
});
```

Clean pipeline.

Scalable.

---

# üß† 1Ô∏è‚É£2Ô∏è‚É£ Advanced Pattern: Action Interceptor

You can modify outgoing action:

```js
const addMetaMiddleware = store => next => action => {
  const enhancedAction = {
    ...action,
    meta: {
      ...action.meta,
      timestamp: Date.now()
    }
  };

  return next(enhancedAction);
};
```

Adds metadata automatically.

Useful for:

* Logging
* Tracking
* Debugging

---

# üè¢ 1Ô∏è‚É£3Ô∏è‚É£ .NET Comparison (For You)

| Redux Middleware     | .NET Equivalent         |
| -------------------- | ----------------------- |
| Middleware pipeline  | ASP.NET middleware      |
| next(action)         | await next()            |
| Error middleware     | Global exception filter |
| Auth middleware      | Authentication handler  |
| Logger middleware    | Logging middleware      |
| Analytics middleware | Telemetry interceptor   |

Redux middleware = frontend request pipeline.

---

# üéØ 1Ô∏è‚É£4Ô∏è‚É£ Interview-Level Questions

You should answer:

* What is middleware in Redux?
* Why does order matter?
* What happens if you don‚Äôt call next(action)?
* Can middleware stop an action?
* How to implement token refresh?
* Difference between thunk and custom middleware?

---

# üìå Blog 11 Summary

You learned:

* Middleware architecture deeply
* Real enterprise middleware examples
* Logger, error handling, analytics, auth refresh
* Infinite loop dangers
* Middleware order importance
* Action interception
* Enterprise-level thinking

Now you understand Redux as a pipeline engine.

